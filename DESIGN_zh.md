# FastAPI Leads Service 设计文档

## 概述

本设计文档详细解释了 FastAPI Leads Service 的架构设计和技术选型决策。该系统是一个现代化的潜在客户（leads）管理系统，采用异步架构设计，支持简历文件上传、邮件通知和状态跟踪。

## 架构设计原则

### 1. 异步优先架构

**设计决策**: 采用 FastAPI + asyncio 的异步架构

**原因**:
- **高并发处理**: 异步架构能更好地处理高并发请求，特别是文件上传和邮件发送等 I/O 密集型操作
- **资源效率**: 异步编程可以显著减少线程切换开销，提高 CPU 利用率
- **现代Web标准**: FastAPI 基于 Starlette，支持 ASGI 标准，提供更好的异步性能
- **生态系统成熟**: Python 异步生态系统已成熟，aiofiles、aiosmtplib 等库提供完整的异步支持

**实现细节**:
- 使用 `aiofiles` 进行异步文件 I/O 操作
- 使用 `aiosmtplib` 进行异步邮件发送
- API 层完全异步，支持并发处理多个请求

### 2. 模块化分层架构

**设计决策**: 采用清晰的分层架构设计

```
app/
├── api/           # API 路由层
├── core/          # 核心配置
├── models/        # 数据模型
├── services/      # 业务服务层
├── server/        # 数据访问层
└── database/      # 数据库配置
```

**原因**:
- **关注点分离**: 各层职责明确，便于维护和测试
- **可扩展性**: 新功能可以轻松添加到相应层中
- **代码复用**: 服务层可以被多个 API 端点复用

**各层职责**:
- **API 层**: 处理 HTTP 请求/响应，路由定义
- **服务层**: 业务逻辑，文件处理，邮件发送
- **数据访问层**: 数据库 CRUD 操作
- **模型层**: 数据结构定义和验证

## 技术栈选型

### 3. Web 框架: FastAPI

**选择理由**:
- **自动 API 文档**: 基于 OpenAPI 标准，自动生成交互式文档
- **类型安全**: 基于 Pydantic 的请求/响应验证
- **异步原生**: 完全支持异步编程
- **性能优秀**: 基于 Starlette，性能接近原生 ASGI
- **开发体验**: 热重载、依赖注入、内置测试客户端

### 4. ORM: SQLAlchemy 2.0

**选择理由**:
- **成熟稳定**: Python 最流行的 ORM 框架
- **灵活性**: 支持多种数据库后端（SQLite/PostgreSQL）
- **异步支持**: 2.0 版本原生支持异步操作
- **查询表达力**: 强大的查询构造 API
- **迁移支持**: 与 Alembic 集成，支持数据库迁移

### 5. 数据验证: Pydantic V2

**选择理由**:
- **类型安全**: 运行时类型检查和转换
- **序列化**: 自动 JSON 序列化/反序列化
- **验证规则**: 丰富的内置验证器和自定义验证
- **FastAPI 集成**: 原生集成，无缝配合

### 6. 异步文件处理: aiofiles

**选择理由**:
- **异步 I/O**: 非阻塞文件操作
- **兼容性**: 与标准 `open()` API 兼容
- **内存效率**: 支持大文件的分块处理
- **生态集成**: 与 FastAPI 的 `UploadFile` 完美配合

### 7. 异步邮件: aiosmtplib

**选择理由**:
- **异步发送**: 非阻塞邮件发送
- **协议支持**: 支持 SMTP/TLS/SSL
- **错误处理**: 完善的异常处理机制
- **配置灵活**: 支持多种邮件服务商

### 8. 配置管理: Pydantic Settings

**选择理由**:
- **环境变量**: 自动读取环境变量
- **类型安全**: 配置项类型检查
- **验证**: 配置值验证和转换
- **文档**: 配置项自动文档化

## 数据模型设计

### 9. Lead 数据模型

**设计决策**: 精简的核心字段设计

```python
class Lead(Base):
    id: Primary Key
    first_name: str (128)
    last_name: str (128)
    email: str (256, indexed)
    resume_path: str (512, optional)
    state: Enum (PENDING/REACHED_OUT)
    created_at: datetime
    updated_at: datetime
```

**设计考虑**:
- **必填字段**: 核心业务信息必须提供
- **字段长度限制**: 防止数据库存储溢出
- **邮箱唯一性**: 通过索引确保业务唯一性
- **时间戳**: 自动维护创建和更新时间

### 10. 状态枚举设计

**选择理由**:
- **业务语义**: PENDING（待处理）、REACHED_OUT（已联系）
- **扩展性**: 枚举易于扩展新状态
- **类型安全**: 防止无效状态值
- **数据库友好**: 存储为字符串，可读性好

## API 设计模式

### 11. RESTful API 设计

**公开接口 (Public APIs)**:
- `POST /public/create_leads`: 创建新 lead
- `PUT /public/update_leads/{id}`: 更新现有 lead

**内部接口 (Internal APIs)**:
- `GET /internal/leads`: 获取所有 leads
- `GET /internal/leads/{id}`: 获取单个 lead
- `PATCH /internal/leads/{id}/state`: 更新状态
- `DELETE /internal/leads/{id}`: 删除 lead

**设计决策**:
- **权限分离**: 公开接口面向客户，内部接口面向管理员
- **操作粒度**: 细粒度的 CRUD 操作
- **REST 原则**: 使用 HTTP 方法语义
- **路径设计**: 清晰的资源层次结构

### 12. 文件上传处理

**设计决策**: Multipart Form-Data + 异步处理

**实现特点**:
- **流式处理**: 大文件分块读取，内存友好
- **文件名安全**: UUID 生成唯一文件名
- **扩展名保留**: 保持原始文件扩展名
- **目录管理**: 自动创建上传目录

### 13. 表单数据验证

**自定义 Form 支持**:
```python
@as_form
class LeadForm(BaseModel):
    first_name: str = Field(..., min_length=1, max_length=128)
    last_name: str = Field(..., min_length=1, max_length=128)
    email: EmailStr
```

**设计理由**:
- **FastAPI 兼容**: 扩展 Pydantic 支持 Form 数据
- **易于修改**: 基于Pydantic，可修改对应字段的参数验证规则

## 服务层设计

### 14. 业务服务分离

**存储服务 (storage_service.py)**:
- 文件保存和删除操作
- 路径管理和安全检查

**邮件服务 (email_service.py)**:
- 邮件模板和发送逻辑
- 配置验证和错误处理

**设计决策**:
- **单一职责**: 每个服务专注一个业务领域
- **复用性**: 服务可被多个 API 端点调用
- **错误隔离**: 服务级错误不会影响其他功能

### 15. 邮件通知架构

**异步处理**:
- 使用 `asyncio.create_task()` 创建后台任务
- 非阻塞的邮件发送，不影响 API 响应时间
- 完善的错误处理和日志记录

## 数据库设计

### 16. SQLite 作为默认数据库

**选择理由**:
- **零配置**: 无需额外安装和配置
- **文件数据库**: 适合小型应用和开发环境
- **ACID 事务**: 完整的数据库事务支持
- **SQLAlchemy 兼容**: 完全支持所有功能
- **迁移便利**: 可以轻松切换到 PostgreSQL

### 17. 数据访问层 (DAO) 模式

**设计决策**: 独立的 DAO 层封装数据库操作

**优势**:
- **数据访问抽象**: API 层无需了解数据库细节
- **事务管理**: 每个操作独立管理数据库会话
- **性能优化**: 可以统一添加缓存、连接池等

## 配置和部署

### 18. 环境变量配置

**设计决策**: 基于 Pydantic Settings 的配置管理

**配置分类**:
- **必需配置**: DATABASE_URL, UPLOAD_DIR
- **可选配置**: SMTP 设置（邮件功能）
- **默认值**: 合理的开发环境默认值

**优势**:
- **环境隔离**: 不同环境使用不同配置
- **安全性**: 敏感信息通过环境变量管理
- **验证**: 配置值自动验证和类型转换

## 错误处理和异常管理

### 19. 分层异常处理

**自定义异常类**:
```python
class EmailError(Exception): ...
class EmailConfigurationError(EmailError): ...
class EmailSendError(EmailError): ...
```

**异常处理策略**:
- **API 层**: HTTP 异常转换为适当的状态码
- **服务层**: 业务异常的详细错误信息
- **全局处理**: 未捕获异常的统一处理

### 20. 邮件发送容错

**设计决策**: 邮件失败不影响核心业务流程

**容错机制**:
- 邮件发送在后台异步执行
- 发送失败只记录日志，不影响 lead 创建
- 完善的错误分类和处理

## 性能优化考虑

### 22. 异步架构优化

**性能优势**:
- **并发处理**: 同时处理多个文件上传和邮件发送
- **资源利用**: 减少线程切换和内存占用
- **响应时间**: 非阻塞 I/O 操作提升响应速度

### 23. 数据库优化

**索引策略**:
- email 字段索引：支持邮箱重复检查
- created_at 降序：优化列表查询性能

**查询优化**:
- 分页查询：避免一次性加载大量数据
- 选择性字段：只查询需要的字段

## 扩展性和维护性

### 24. 模块化设计

**扩展点**:
- **新服务**: 可以轻松添加新的业务服务
- **新 API**: 遵循现有模式添加新端点
- **新状态**: 枚举扩展支持新业务状态

## 部署和运维

### 25. 容器化支持

**Docker 部署**:
```dockerfile
FROM python:3.11-slim
# 轻量级基础镜像
# 完整的依赖打包
# 环境变量配置
```

### 26. 生产环境考虑

**WSGI 服务器**: Gunicorn + Uvicorn Workers
**进程管理**: 多个 worker 进程提高并发
**日志配置**: 结构化日志便于监控
**监控端点**: 健康检查和指标暴露

## 总结

这个 FastAPI Leads Service 的设计体现了现代 Web 应用的最佳实践：

- **异步优先**: 充分利用 Python 异步编程的优势
- **分层架构**: 清晰的职责分离和模块化设计
- **类型安全**: 端到端的类型检查和验证
- **可扩展性**: 易于添加新功能和扩展现有功能
- **生产就绪**: 完善的错误处理、配置管理和部署支持

通过精心选择的技术栈和架构模式，该系统既满足了当前的需求，又为未来的扩展和维护奠定了坚实的基础。
